# API Integration

### Getting Started
PayFast is in the process of rolling out a fully-fledged RESTful API. The first endpoints available will be for the management of subscriptions, with further functionality being released in the near future.

## How it Works
All API communications with PayFast take the form of standard HTTP requests. These requests are made against a set of endpoints, depending on the action required. Variables may be sent via both the headers and body of each request as specified. The minimum set of variables required to connect to PayFast’s API services are detailed below.

API services follow RESTful principles, and thus rely on HTTP verbs to describe the action being requested:
- HTTP GET is used retrieve a resource.
- HTTP PUT is used where an action is required on a resource.
- HTTP POST is used where a resource needs to be created.
- HTTP PATCH is used to update all / subset of a resource.

::: warning 
Using the wrong verb for any endpoint will result in a Bad Request (400) error
:::

### Minimum Requirements
At a minimum, the following must be provided to gain access to the API ecosystem:
1. A valid and an API enabled PayFast merchant account
2. A passphrase as set on the merchant account settings page
3. PayFast merchant ID
4. The version of the API you want to interact with
5. A valid merchant signature
6. A timestamp included in the request

### Input Formats and Content Types
Sending data to the API may be done in one of two ways:
- application/x-www-form-urlencoded Essentially one big query string where all name / value pairs are separated by the ‘&’ symbol, with an equal (=) symbol between name and value. This is similar to submitting the traditional HTML FORM via POST (eg. frequency=3&cycles=12…).
- application/json Fields should be passed in as a single-level JSON representation. Example to the right in the Json tab.

```JSON
{
    "frequency":3,
    "cycles":12
}
```

### API Signature Generation

The security signature of the transmitted data takes the form of an <b>MD5 hash of the alphabetised submitted variables, header and body variables</b>, as well as the passphrase. The string from which the hash is created is the concatenation of the name value pairs of all the <b>non-blank variables</b> with <b>‘&’</b> used as a separator. Each value should also be <b>urlencoded</b> (eg. “merchant-id=10000100&passphrase=passphrase&..&version=v1”).

The generated MD5 signature must be passed in the header of the request and this hash will be regenerated by the API and compared to ensure the integrity of the data transfer.

```php
<?php

// $pfData will contain all of the values to be sent to the API,
// As well as in both the headers and the body.
$pfData = '$fieldsToTransmit';

// Construct variables 
foreach( $pfData as $key => $val ) {
    $data[$key] = stripslashes( $val );
}

if( isset( $passPhrase ) ) {
    $pfData['passphrase'] = $passPhrase;
}

// Sort the array by key, alphabetically
ksort($pfData);

// Normalise the array into a parameter string
foreach( $pfData as $key => $val ) {
    if( $key != 'signature' ) {
        $pfParamString .= $key .'='. urlencode( $val ) .'&amp;';
    }
}

// Remove the last '&amp;' from the parameter string
$pfParamString = substr( $pfParamString, 0, -1 );
$signature = md5( $pfParamString );
```

#### Difference between Checkout Page Signature generation and API Signature Generation

|    | Checkout Page Signature |	API Signature |
| ----------- | -------------------------------------------| ----------------------------|
| Merchant ID variable name | merchant_id | merchant-id |
| Order of the string variables (before hashing) | The variables need to be ordered correctly, as per the checkout page documentation | 	The data is ksorted, in other words, the variable are ordered alphabetically |
| Amount | The amount which the buyer must pay, in RANDS (ZAR) | The amount which the buyer must pay, in CENTS (ZAR) |

### Merchant Passphrase
The signature described previously utilises a passphrase that is chosen by the merchant and is linked to their account. Every request sent by the merchant will have a signature that is salted with their passphrase. The passphrase is considered a secret between the merchant and PayFast and should never be sent or given out.

::: tip
A passphrase must be set by the merchant before any API interaction is allowed
:::

The merchant may set their own passphrase by:

1. Login to PayFast using their merchant credentials.
2. Clicking on ‘Settings’, and then ‘Edit’ under the ‘Security Pass Phrase’ section.
3. Inputting the desired passphrase, and clicking ‘Update’

### Request Timestamp
Each request to the API must contain an ISO-8601 formatted timestamp. This field must be present in each request body along with the signature. Failure to include this field will result in an error. The timestamp field must be formatted according to ISO-8601 standards, and be in the following format:

<span style="background-color: #e6e6ff">YYYY-MM-DDTHH:MM[(+-)HH:MM] (e.g. 2016-04-01T12:00:01+02:00)</span>

The time zone offset group ((+-)HH:MM) is optional. If not included, the default will be assumed to be GMT +2.

### IP Whitelisting
Each request to the API may be controlled by an IP address whitelist. If set, the IP address of the server completing the API call must be in the given list, else the action will not be processed. The whitelist can be set on the merchant’s settings page and is an optional security setting.

### Variable format
The below table describes the formats of the variables used when integrating with PayFast.

| Format | 	Description|
| -------- | ---------------------------|
| alphanumeric |	A-Z, a-z, 0-9 |
| alphanumericextended |	alphanumeric and special characters _-/ |
| char |	maximum number of characters |
| decimal |	numeric and optional decimal point |
| email |	valid email address |
| numeric |	numeric digits, 0-9 |
| url/alphanumericspecial |	alphanumeric and special characters _-/:&?#=+ |
| MD5 hash (characters must be in lower case) |	32 character hexadecimal number |


## Recurring Billing

### Introduction
The recurring service will allow for merchants to create two methods of recurring payments, one method being a traditional subscription model of a recurring charge on a given date, the other a one-click ad hoc model where the future dates and amounts of payments may be unknown.

### How it Works
In order to setup a subscription or ad hoc payment you will first need to follow the [Web Integration](https://developers.payfast.co.za/documentation/#web-integration) documentation and include the necessary payment parameters for subscriptions or ad hoc payments. Once setup, the buyer will not have to be redirected to PayFast again in order to make payment, and you will be able to perform the below mentioned actions via the API making use of the token sent to your notify URL as part of the ITN. For a subscription, PayFast will charge the credit card according to the data sent in the payment request, for ad hoc payments PayFast will only charge the buyers card when instructed to do so via the API.

<img :src="$withBase('/images/getting_started_recurring.png')" alt="Getting started with recurring billing and Payfast">

### Subscriptions
The buyer who chooses to enter into a subscription with a merchant will, after checkout, be redirected to PayFast where only the credit card payment option will be available. After a successful first payment there is no need for the buyer to make any further manual payments for the subscription. The recurring amount will be deducted from their credit card in accordance with the frequency, billing date and number of payments (cycles) given. Each successful payment will create an ITN to the merchant and they will be able to manage the subscription via an API or from their PayFast account.

### Ad Hoc Payments
A buyer who agrees to enter into an ad hoc payment with a merchant will, after checkout, be redirected to PayFast where only the credit card payment option will be available. After a successful first payment there is no need for the buyer to make any further manual payments. For any future payments the merchant will only need to send a token value to the API to have the associated credit card of the buyer charged. On each successful payment, an ITN will be sent to the merchant and they will be able to manage the subscription via the API or from their PayFast account.

### R0.00 Initial Transaction
It is possible to setup a subscription or ad hoc payment with an initial amount of R0.00. This would be used with subscriptions if the first cycle/period is free (the recurring_amount value would need to be a minimum of R5.00), or, in the case of ad hoc payments it is used to setup the buyers account on the merchants site, allowing for future payments. If the initial amount is R0.00 the buyer will be redirected to PayFast, where they will input their credit card details and go through 3D Secure, but no money will be deducted.

### Integration Options

#### Pay Now Button
 One of the easiest ways to create a subscription is to use a [Pay Now](https://www.payfast.co.za/html-buttons/) button. The button code can be generated from your [PayFast dashboard](https://www.payfast.co.za/user/login). Simply fill in the necessary fields (ensuring the subscription fields are populated), click ‘generate’ and copy the code to your website.

::: warning
Only available for subscriptions. Ad hoc payments will require API integration.
:::

#### Payment Request
Should a merchant require a buyer to start a subscription without the buyer going onto a website they can make use of the [Request Payment](https://www.payfast.co.za/request-money/) feature on their [PayFast dashboard](https://www.payfast.co.za/user/login). The merchant will need to fill in the required fields, then PayFast will send an email on behalf of the merchant with a button to start the subscription. Once the initial payment is made the subscription will be active.

::: warning
Only available for subscriptions. Ad hoc payments will require API integration.
:::

#### E-commerce and Platform Plugins
Subscriptions will be supported by a number of PayFast supported plugins which may be downloaded from our shopping carts page. Currently the following plugins support subscriptions:

- Gravity Forms
- WP Invoice
- Paid Membership Pro
- WHMCS (Uses Ad Hoc)
- WooCommerce Subscriptions (Uses Ad Hoc, managed by WooThemes)
- Shopify
- OpenCart
- Drupal Commerce

Due to some integration requirements, ad hoc payments may not be available via some of our plugins.

#### Custom Integration
To accommodate recurring billing for the widest possible merchant base, the traditional custom integration has been extended to allow for the additional subscription fields. Future versions of the API will implement a more RESTful approach with additional security options. Please follow the developer documentation in order to build a custom integration, taking note of the subscription fields on the checkout page, and the return variables.

A passphrase is compulsory for all subscriptions which is set on the merchant’s PayFast settings page. Generation of the signature sent to PayFast follows the current documentation. The order of the additional subscription fields is important and can be seen in the table on the checkout page.

### Recurring Maintenance
#### Buyer Perspective
A buyer is able to login to their PayFast account and view or cancel any of their recurring billings. When cancelled by the buyer, the merchant will be notified via email, and/or an ITN will be sent to the notify_url with the payment_status of CANCELLED. The buyer will be able to change the credit card, including card verification and 3D secure, linked to the subscription or ad hoc payment. Should a buyer not have a PayFast account, they will be able to register at any point to manage their subscriptions.

#### Expired Cards
A buyer will be notified via email a month in advance about registered cards which will expire and are linked to an active subscription/agreement. Instructions will be provided in the notification email to help them link a new card to their subscription, so that they do not experience any break in payments or service. A buyer will be permitted to register for subscriptions even if the card is due to expire before the end of the subscription term.

#### Merchant Perspective
The following actions may be accomplished via the PayFast dashboard, as well as the API

##### Cancel
Any recurring billing type may be cancelled from the PayFast merchant account. The buyer will be notified via email of this action.

##### Pause
Should a subscription be paused the remaining payments (cycles) will remain untouched. The end date of the subscription moves on by the number of paused frequency period(s). Effectively the buyer gains a payment gap and the number of payments will still be the same as originally requested. A free month(s) could be provided by pausing (pause) a subscription and reducing the number of cycles by making an update to the subscription.

Only the merchant has the functionality to pause or unpause a subscription.

#### Failed Payments
##### Subscriber Out of Funds
PayFast will try a number of times to reprocess a payment where the buyer does not have funds on their credit card. On failure, the buyer will be notified, allowing some time for the problem to be resolved. On a complete failure (after X amount of times), the subscription will be ‘locked’ and will need some action from the merchant to reactivate on the PayFast account or via the API pause endpoint.

##### ad hoc payments Out of Funds
When receiving the API call to charge an agreement’s credit card via token, PayFast will attempt to charge the card immediately and the failed response will be returned returned.

##### System Issues
PayFast will resolve any system issue that may cause payment failure. Subscription payments will resume once all systems have been restored.

## Subscription Payments API Endpoints

### URL Composition
The API exposes the following endpoints which will allow Merchants the ability to interact with subscriptions on their accounts.

URLs to interact with take the following form:

::: tip
https://api.payfast.co.za/[endpoint]/[token]/[action]?testing=true
:::
| | |
|-----------|---------|
| [endpoint] |	This should be set to “subscriptions” |
| [token]	| The 36 character alphanumeric string returned to your notify URL via the ITN callback which uniquely identifies a subscription |
| [action] |	This will be the verb describing the intended action to take. |
| testing=true |	Include this text should you wish to make use of the PayFast sandbox for testing purposes. |

### Actions Available via the API
If using a FORM to post data to any endpoint, all FORMs must submit via normal POST forms and have a hidden value called ‘_method’, set to the appropriate verb.

#### Recurring Billing Type 1 – Subscription Payments
#### [GET] ping

Used to check if the API is responding to requests.

<span style="background-color: #e6e6ff">https://api.payfast.co.za/ping</span>

| NAME | 	DESCRIPTION |	REQUIRED |	FORMAT |
| --------- | -------- | --------- | --------- |
| merchant-id | Header, the Merchant ID as given by the PayFast system.	| Yes |	numeric, 8 char |
| version	| Header, the PayFast API version.	| Yes |	v1 |
| timestamp	| Header, the current timestamp. |	Yes |	ISO-8601 date and time, YYYY-MM-DDTHH:MM:SS[+HH:MM] |
| signature |	Header, MD5 hash of the alphabetised submitted header and body variables, as well as the passphrase.	| Yes	| MD5 hash, characters must be in lower case |

<pre>Successful ping response</pre>
```JSON
"API V1"
```
<pre>Unsuccessful ping response</pre>
```JSON
{
  "code":404,
  "status":"error",
  "data":{
    "response":false
  }
}
```
#### [PUT] pause

Pause a subscription, for a duration indicated by a ‘cycles’ payload variable.

<span style="background-color: #e6e6ff">https://api.payfast.co.za/subscriptions/dc0521d3-55fe-269b-fa00-b647310d760f/pause</span>

| NAME | 	DESCRIPTION |	REQUIRED |	FORMAT |
| --------- | -------- | --------- | --------- |
| merchant-id | Header, the Merchant ID as given by the PayFast system.	| Yes |	numeric, 8 char |
| version	| Header, the PayFast API version.	| Yes |	v1 |
| timestamp	| Header, the current timestamp. |	Yes |	ISO-8601 date and time, YYYY-MM-DDTHH:MM:SS[+HH:MM] |
| signature |	Header, MD5 hash of the alphabetised submitted header and body variables, as well as the passphrase.	| Yes	| MD5 hash, characters must be in lower case |
| cycles |	Body, number of cycles to pause the subscription for. Default is 1 if not given.	| Optional |	numeric |


<pre>Successful pause response</pre>
```JSON
{
  "code":200,
  "status":"success",
  "data":{
    "response":true
  }
}
```
<pre>Unsuccessful pause response</pre>
```JSON
{
  "code":500,
  "status":"error",
  "data":{
    "response":false
  }
}
```
#### [PUT] cancel

This will cancel a subscription entirely.

<span style="background-color: #e6e6ff">https://api.payfast.co.za/subscriptions/dc0521d3-55fe-269b-fa00-b647310d760f/cancel</span>

| NAME | 	DESCRIPTION |	REQUIRED |	FORMAT |
| --------- | -------- | --------- | --------- |
| merchant-id | Header, the Merchant ID as given by the PayFast system.	| Yes |	numeric, 8 char |
| version	| Header, the PayFast API version.	| Yes |	v1 |
| timestamp	| Header, the current timestamp. |	Yes |	ISO-8601 date and time, YYYY-MM-DDTHH:MM:SS[+HH:MM] |
| signature |	Header, MD5 hash of the alphabetised submitted header and body variables, as well as the passphrase.	| Yes	| MD5 hash, characters must be in lower case |

<pre>Successful cancel response</pre>
```JSON
{
  "code":200,
  "status":"success",
  "data":{
    "response":true
  }
}
```
<pre>Unsuccessful cancel response</pre>
```JSON
{
  "code":500,
  "status":"error",
  "data":{
    "response":false
  }
}
```
#### [PATCH] update

This allows for multiple subscription values to be updated

<span style="background-color: #e6e6ff">https://api.payfast.co.za/subscriptions/dc0521d3-55fe-269b-fa00-b647310d760f/update</span>

| NAME | 	DESCRIPTION |	REQUIRED |	FORMAT |
| --------- | -------- | --------- | --------- |
| merchant-id | Header, the Merchant ID as given by the PayFast system.	| Yes |	numeric, 8 char |
| version	| Header, the PayFast API version.	| Yes |	v1 |
| timestamp	| Header, the current timestamp. |	Yes |	ISO-8601 date and time, YYYY-MM-DDTHH:MM:SS[+HH:MM] |
| signature |	Header, MD5 hash of the alphabetised submitted header and body variables, as well as the passphrase.	| Yes	| MD5 hash, characters must be in lower case |
| cycles	| Body, the number of cycles for the subscription.	| Optional	| numeric |
| frequency |	Body, the frequency for the subscription	| Optional	| numeric |
| run_date |	Body, the next run date for the subscription. |	Optional |	YYYY-MM-DD |
| amount |	Body, the amount which the buyer must pay, in CENTS (ZAR).	| Optional |	numeric |

<pre>Successful update response</pre>
```JSON
{
  "code":200,
  "status":"success",
  "data":{
    "response":{
      "token":"a3b3ae55-ab8b-b388-df23-4e6882b86ce0",
      "amount":"1628",
      "cycles":"14",
      "cycles_complete":"9",
      "frequency":"3",
      "status":"1",
      "run_date":"2016-07-04"
    }
  }
}
```
<pre>Unsuccessful update response</pre>
```JSON
{
  "code":500,
  "status":"error",
  "data":{
    "response":false
  }
}
```
::: tip
The body must contain at least one of the optional payload variables.
:::

::: tip
The amount field in the API is in cents and not decimal notation as per normal PayFast integrations.
:::

#### [GET] fetch

Returns a JSON object containing the subscription details

<span style="background-color: #e6e6ff">https://api.payfast.co.za/subscriptions/dc0521d3-55fe-269b-fa00-b647310d760f/fetch</span>

| NAME | 	DESCRIPTION |	REQUIRED |	FORMAT |
| --------- | -------- | --------- | --------- |
| merchant-id | Header, the Merchant ID as given by the PayFast system.	| Yes |	numeric, 8 char |
| version	| Header, the PayFast API version.	| Yes |	v1 |
| timestamp	| Header, the current timestamp. |	Yes |	ISO-8601 date and time, YYYY-MM-DDTHH:MM:SS[+HH:MM] |
| signature |	Header, MD5 hash of the alphabetised submitted header and body variables, as well as the passphrase.	| Yes	| MD5 hash, characters must be in lower case |

<pre>Successful fetch response</pre>
```JSON
{
  "code":200,
  "status":"success",
  "data":{
    "response":{
      "token":"a3b3ae55-ab8b-b388-df23-4e6882b86ce0",
      "amount":"1628",
      "cycles":"14",
      "cycles_complete":"9",
      "frequency":"3",
      "status":"1",
      "run_date":"2016-07-04"
    }
  }
}
```
<pre>Unsuccessful fetch response</pre>
```JSON
{
  "code":500,
  "status":"error",
  "data":{
    "response":false
  }
}
```

### CURL Examples
The examples below demonstrate cURL calls containing the following:

- HTTP Method: PUT
- URL: https://api.payfast.co.za/
- Endpoint: subscriptions/[Token]/[Action]
- The calls are made to v1 (version 1) of the API. The merchant-id, version, timestamp and signature are all included as request headers.

#### Pausing a subscription
<span style="background-color: #e6e6ff">curl -v -X PUT -H “merchant-id: 10000100” -H “version: v1” -H “timestamp=2016-04-01T12:00:01” -H “signature=840654b40a8b312e54650e1613696b44” https://api.payfast.co.za/subscriptions/dc0521d3-55fe-269b-fa00-b647310d760f/pause</span>
<br /><br />An example of the request information sent can be seen below:

<span style="background-color: #e6e6ff">>PUT https://api.payfast.co.za/subscriptions/dc0521d3-55fe-269b-fa00-b647310d760f/pause HTTP/1.1</span><br />
<span style="background-color: #e6e6ff">>User-Agent: curl/7.37.0</span><br />
<span style="background-color: #e6e6ff">>Host: api.payfast.co.za</span><br />
<span style="background-color: #e6e6ff">>Accept: */*</span><br />
<span style="background-color: #e6e6ff">>merchant-id: 10000100</span><br />
<span style="background-color: #e6e6ff">>version: v1</span><br />
<span style="background-color: #e6e6ff">>timestamp: 2016-04-01T12:00:01</span><br />
<span style="background-color: #e6e6ff">>signature: 840654b40a8b312e54650e1613696b44</span><br />
<span style="background-color: #e6e6ff">>Content-Length: 0</span><br />
<span style="background-color: #e6e6ff">>Content-Type: application/x-www-form-urlencoded</span><br />
```php
<?php
$payload = 'Your Pay Load Added';
$token = 'dc0521d3-55fe-269b-fa00-b647310d760f';
// Set up cURL, add "?testing=true" to the end when testing
$ch = curl_init( "https://api.payfast.co.za/subscriptions/". $token ."/pause" );
curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
curl_setopt( $ch, CURLOPT_HEADER, false );
curl_setopt( $ch, CURLOPT_SSL_VERIFYPEER, 1 );
curl_setopt( $ch, CURLOPT_TIMEOUT, 60 );
curl_setopt( $ch, CURLOPT_CUSTOMREQUEST, "PUT" );
// For the body values such as amount, frequency, & date
curl_setopt( $ch, CURLOPT_POSTFIELDS, http_build_query( $payload ) );
curl_setopt( $ch, CURLOPT_VERBOSE, true );
curl_setopt( $ch, CURLOPT_HTTPHEADER, array(
    'version: v1',
    'merchant-id: 10000100',
    'signature: 840654b40a8b312e54650e1613696b44',
    'timestamp: 2016-04-01T12:00:01' 
) );

// Execute and close cURL
$data = curl_exec( $ch );
curl_close( $ch );
```

#### Return Variables

All responses from the API follow a standard format. It is a JSON encoded string containing code, status and data elements. The data element may contain more than one message.

Outline of a JSON formatted response:

- code: The HTTP status code for the result
- status: A more verbose description of the result
- data: Will contain a response of either true or false for the action and may also contain one or more description(s) for the reason of the result

<pre>Example of success response</pre>
```JSON
{
        "code": 200,
        "status": "success",
        "data": {
                "response": true,
                "message": "Success"
        }
} 
```
<pre>Example of a failure response</pre>
```JSON
{
        "code": 400,
        "status": "failed",
        "data": {
                "response": false,
                "message": "Failure"
        }
}
```
### Errors and Causes
The following errors can be expected during authentication when connecting to PayFast.

| CODE	| ERROR MESSAGE	| REASON |
| ------------------- | -------------- | --------------------|
| 400 | Required variables not present in request<br /><br />Value for signature is not in the expected format<br /><br />API version is not valid<br /><br />Signature not present in headers | The request is missing some or all of the required fields.<br /><br />Generated when the merchant signature provided is not an MD5 hash, or is malformed.<br /><br />Issued when the version header refers to a version that does not exist, or is malformed.<br /><br />The signature has not been provided. |
| 401 | Merchant not found<br /><br />Request origin not recognised<br /><br />Request origin could not be verified<br /><br />Merchant authorisation failed | The given merchant ID was not found.<br /><br />Generated when the request does not contain a REMOTE_ADDR value.<br /><br />Occurs when the request is made from a location not specified in the whitelist.<br /><br />The signature is incorrect. |
| 404 | Service / endpoint not found | The endpoint does not exist or the requesting merchant does not have permission to access. |
| 429 | Signature rate limit reached, please try again in a few minutes	 | The rate limit was hit. |
| 500 | Application Error<br /><br />Communication Failure | Application Error.<br /><br />Networking issue with the API. |
	
## Ad Hoc Payments API Endpoints

### URL Composition
The API exposes the following endpoints which will allow Merchants the ability to interact with subscriptions on their accounts.

URLs to interact with take the following form:
::: details 
https://api.payfast.co.za/[endpoint]/[token]/[action]?testing=true
:::
| | |
|--|--|
| [endpoint] |	This should be set to “subscriptions” |
| [token] |	The 36 character alphanumeric string returned to your notify URL via the ITN callback which uniquely identifies a subscription |
| [action] |	This will be the verb describing the intended action to take. |
| testing=true |	Include this text should you wish to make use of the PayFast sandbox for testing purposes. |

### Actions Available via the API
If using a FORM to post data to any endpoint, all FORMs must submit via normal POST forms and have a hidden value called ‘_method’, set to the appropriate verb.

### Recurring Billing Type 2 – Ad Hoc Payments

#### [GET] ping

Used to check if the API is responding to requests.

<span style="background-color: #e6e6ff">https://api.payfast.co.za/ping</span>

| NAME | 	DESCRIPTION |	REQUIRED |	FORMAT |
| --------- | -------- | --------- | --------- |
| merchant-id | Header, the Merchant ID as given by the PayFast system.	| Yes |	numeric, 8 char |
| version	| Header, the PayFast API version.	| Yes |	v1 |
| timestamp	| Header, the current timestamp. |	Yes |	ISO-8601 date and time, YYYY-MM-DDTHH:MM:SS[+HH:MM] |
| signature |	Header, MD5 hash of the alphabetised submitted header and body variables, as well as the passphrase.	| Yes	| MD5 hash, characters must be in lower case |

<pre>Successful ping response</pre>
```JSON
"API V1"
```
<pre>Unsuccessful ping response</pre>
```JSON
{
  "code":404,
  "status":"error",
  "data":{
    "response":false
  }
}
```
#### [POST] adhoc

Charge an ad hoc subscription based on token.

<span style="background-color: #e6e6ff">https://api.payfast.co.za/subscriptions/dc0521d3-55fe-269b-fa00-b647310d760f/adhoc</span>

| NAME | 	DESCRIPTION |	REQUIRED |	FORMAT |
| --------- | -------- | --------- | --------- |
| merchant-id | Header, the Merchant ID as given by the PayFast system.	| Yes |	numeric, 8 char |
| version | 	Header, the PayFast API version. |	Yes |	v1 |
| timestamp |	Header, the current timestamp. |	Yes |	ISO-8601 date and time, YYYY-MM-DDTHH:MM:SS[+HH:MM] |
| signature |	Header, MD5 hash of the alphabetised submitted header and body variables, as well as the passphrase. | 	Yes	MD5 hash, characters must be in lower case |
| amount |	Body, the amount which the buyer must pay, in CENTS (ZAR). |	Yes | 	numeric |
| item_name |	Body, the name of the item being charged for. | 	Yes | 	alphanumeric |
| item_description | 	Body, the description of the item being charged for. |	optional |	alphanumeric |
| itn |	Body, specify whether an ITN must be sent for the ad hoc charge (1 by default).	 | optional | 	true or false |
| m_payment_id | 	Body, unique payment ID on the merchant’s system. | 	optional | 	alphanumeric |
| cc_cvv |	Body, the credit card cvv number. |	optional |	numeric |

<pre>Successful Adhoc response</pre>
```JSON
{
  "code":200,
  "status":"success",
  "data":{
    "response":true
  }
}
```
<pre>Unsuccessful ping response</pre>
```JSON
{
  "code":500,
  "status":"error",
  "data":{
    "response":false
  }
}
```
::: tip
The amount field in the API is in cents and not decimal notation as per normal PayFast integrations.
:::

#### [GET] fetch

Returns a JSON object containing the subscription details.

<span style="background-color: #e6e6ff">https://api.payfast.co.za/subscriptions/dc0521d3-55fe-269b-fa00-b647310d760f/fetch</span>

| NAME | 	DESCRIPTION |	REQUIRED |	FORMAT |
| --------- | -------- | --------- | --------- |
| merchant-id | Header, the Merchant ID as given by the PayFast system.	| Yes |	numeric, 8 char |
| version	| Header, the PayFast API version.	| Yes |	v1 |
| timestamp	| Header, the current timestamp. |	Yes |	ISO-8601 date and time, YYYY-MM-DDTHH:MM:SS[+HH:MM] |
| signature |	Header, MD5 hash of the alphabetised submitted header and body variables, as well as the passphrase.	| Yes	| MD5 hash, characters must be in lower case |

<pre>Successful fetch response</pre>
```JSON
{
  "code":200,
  "status":"success",
  "data":{
    "response":{
      "token":"a3b3ae55-ab8b-b388-df23-4e6882b86ce0",
      "status":1
    }
  }
}
```
<pre>Unsuccessful fetch response</pre>
```JSON
{
  "code":500,
  "status":"error",
  "data":{
    "response":false
  }
}
```

#### [PUT] cancel

This will cancel a subscription entirely.

<span style="background-color: #e6e6ff">https://api.payfast.co.za/subscriptions/dc0521d3-55fe-269b-fa00-b647310d760f/cancel</span>

| NAME | 	DESCRIPTION |	REQUIRED |	FORMAT |
| --------- | -------- | --------- | --------- |
| merchant-id | Header, the Merchant ID as given by the PayFast system.	| Yes |	numeric, 8 char |
| version	| Header, the PayFast API version.	| Yes |	v1 |
| timestamp	| Header, the current timestamp. |	Yes |	ISO-8601 date and time, YYYY-MM-DDTHH:MM:SS[+HH:MM] |
| signature |	Header, MD5 hash of the alphabetised submitted header and body variables, as well as the passphrase.	| Yes	| MD5 hash, characters must be in lower case |

<pre>Successful cancel response</pre>
```JSON
{
  "code":200,
  "status":"success",
  "data":{
    "response":true
  }
}
```
<pre>Unsuccessful cancel response</pre>
```JSON
{
  "code":500,
  "status":"error",
  "data":{
    "response":false
  }
}
```
### CURL Examples
The examples below demonstrate cURL calls containing the following:

- HTTP Method: POST
- URL: https://api.payfast.co.za/
- Endpoint: subscriptions/[Token]/[Action] The calls are made to v1 (version 1) of the API. The merchant-id, version, timestamp and signature are all included as request headers. The amount, item_name and item_description are included in the request body.

#### Charging a Token

<span style="background-color: #e6e6ff">> PUT https://api.payfast.co.za/subscriptions/dc0521d3-55fe-269b-fa00-b647310d760f/adhoc HTTP/1.1</span>
<br/><br/>
<span style="background-color: #e6e6ff">> User-Agent: curl/7.37.0</span>
<br/><br/>
<span style="background-color: #e6e6ff">> Host: api.payfast.co.za</span>
<br/><br/>
<span style="background-color: #e6e6ff">> Accept: */*</span>
<br/><br/>
<span style="background-color: #e6e6ff">> merchant-id: 10000100</span>
<br/><br/>
<span style="background-color: #e6e6ff">> version: v1</span>
<br/><br/>
<span style="background-color: #e6e6ff">> timestamp: 2016-04-01T12:00:01</span>
<br/><br/>
<span style="background-color: #e6e6ff">> signature: 840654b40a8b312e54650e1613696b44</span>
<br/><br/>
<span style="background-color: #e6e6ff">> Content-Length: 0</span>
<br/><br/>
<span style="background-color: #e6e6ff">> Content-Type: application/x-www-form-urlencoded</span>
```php
<?php
// Array used for CURLOPT_POSTFIELDS
$payload = array(
    'amount' => '$amount',
    'item_name' => '$itemName',
    'item_description' => '$itemDescription' //optional
);


$token = 'dc0521d3-55fe-269b-fa00-b647310d760f';
// Set up cURL, add "?testing=true" to the end when testing
$ch = curl_init( "https://api.payfast.co.za/subscriptions/". $token ."/adhoc" );
curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
curl_setopt( $ch, CURLOPT_HEADER, false );
curl_setopt( $ch, CURLOPT_SSL_VERIFYPEER, 1 );
curl_setopt( $ch, CURLOPT_TIMEOUT, 60 );
curl_setopt( $ch, CURLOPT_CUSTOMREQUEST, "POST" );
// For the body values such as amount, item_name, & item_description
curl_setopt( $ch, CURLOPT_POSTFIELDS, http_build_query( $payload ) );
curl_setopt( $ch, CURLOPT_VERBOSE, 1 );
curl_setopt( $ch, CURLOPT_HTTPHEADER, array(
    'version: v1',
    'merchant-id: 10000100',
    'signature: 840654b40a8b312e54650e1613696b44',
    'timestamp: 2016-04-01T12:00:01' 
) );

// Execute and close cURL
$response = curl_exec( $ch );
curl_close( $ch );
```
<pre>Example of a success response</pre>
```JSON
{
         "code": 200,
         "status": "success",
         "data": {
                 "response": true,
                 "message": "Success"
         }
 }
```
<pre>Example of a failure response</pre>
```JSON
{
        "code": 400,
        "status": "failed",
        "data": {
                "response": false,
                "message": "Failure"
        }
}
```
### Return Variables
All responses from the API follow a standard format. It is a JSON encoded string containing code, status and data elements. The data element may contain more than one message.
Outline of a JSON formatted response:
- code: The HTTP status code for the result
- status: A more verbose description of the result
- data: Will contain a response of either true or false for the action and may also contain one or more description(s) for the reason of the result


### Errors and Causes
The following errors can be expected during authentication when connecting to PayFast.


| CODE	| ERROR MESSAGE	| REASON | 
| -------------------------- | --------------------------- | ------------------------------- |
| 400	| Required variables not present in request<br/><br/>Value for signature is not in the expected format<br/><br/>API version is not valid<br/><br/>Signature not present in headers | The request is missing some or all of the required fields.<br/><br/>Generated when the merchant signature provided is not an MD5 hash, or is malformed.<br/><br/>Issued when the version header refers to a version that does not exist, or is malformed.<br/><br/>The signature has not been provided. |
| 401 | Merchant not found<br/><br/>Request origin not recognised<br/><br/>Request origin could not be verified<br/><br/>Merchant authorisation failed | The given merchant ID was not found.<br/><br/>Generated when the request does not contain a REMOTE_ADDR value.<br/><br/>Occurs when the request is made from a location not specified in the whitelist.<br/><br/>The signature is incorrect. |
| 404 |	Service / endpoint not found |	The endpoint does not exist or the requesting merchant does not have permission to access. |
| 429 |	Signature rate limit reached, please try again in a few minutes	| The rate limit was hit. |
| 500 | Application Error<br/><br/>Communication Failure | Application Error.<br/><br/>Networking issue with the API. |

## PayFast Account
### Available actions for accounts
The actions described below are available via the API in order for merchants to interact with their PayFast account.

### Transaction History
The URL to interact with will take the following form:

::: details
https://api.payfast.co.za/transactions/history/[timeframe]
:::

#### [GET] history

Obtain the transaction history for given a period.

<span style="background-color: #e6e6ff">https://api.payfast.co.za/transactions/history?from=2017-01-01&to=2017-02-01</span>

| NAME | 	DESCRIPTION |	REQUIRED |	FORMAT |
| --------- | -------- | --------- | --------- |
| merchant-id | Header, the Merchant ID as given by the PayFast system.	| Yes |	numeric, 8 char |
| version	| Header, the PayFast API version.	| Yes |	v1 |
| timestamp	| Header, the current timestamp. |	Yes |	ISO-8601 date and time, YYYY-MM-DDTHH:MM:SS[+HH:MM] |
| signature |	Header, MD5 hash of the alphabetised submitted header and body variables, as well as the passphrase.	| Yes	| MD5 hash, characters must be in lower case |
| from |	Body, start date for the time period. Defaults to current month |	Optional |	YYYY-MM-DD |
| to | 	Body, end date for the time period. Defaults to current date	| Optional | 	YYYY-MM-DD |

::: details
A successful daily response will return comma-separated values (CSV) of required the transactions.
:::

<pre>Unsuccessful history response</pre>
```JSON
{
  "code":500,
  "status":"error",
  "data":{
    "response":false
  }
}
```

#### [GET] weekly

Obtain the transaction history for a given weekly period.

<span style="background-color: #e6e6ff">https://api.payfast.co.za/transactions/history/weekly?date=2017-01-01</span>

| NAME | 	DESCRIPTION |	REQUIRED |	FORMAT |
| --------- | -------- | --------- | --------- |
| merchant-id | Header, the Merchant ID as given by the PayFast system.	| Yes |	numeric, 8 char |
| version	| Header, the PayFast API version.	| Yes |	v1 |
| timestamp	| Header, the current timestamp. |	Yes |	ISO-8601 date and time, YYYY-MM-DDTHH:MM:SS[+HH:MM] |
| signature |	Header, MD5 hash of the alphabetised submitted header and body variables, as well as the passphrase.	| Yes	| MD5 hash, characters must be in lower case |
| date |	Body, date of the time period. Defaults to current week |	Optional |	YYYY-MM-DD |

::: details
 A successful weekly response will return comma-separated values (CSV) of required the transactions.
:::

```
<pre>Unsuccessful weekly response</pre>
```JSON
{
  "code":500,
  "status":"error",
  "data":{
    "response":false
  }
}
```

#### [GET] monthly

Obtain the transaction history for a given monthly period.

<span style="background-color: #e6e6ff">https://api.payfast.co.za/transactions/history/monthly?date=2017-01</span>

| NAME | 	DESCRIPTION |	REQUIRED |	FORMAT |
| --------- | -------- | --------- | --------- |
| merchant-id | Header, the Merchant ID as given by the PayFast system.	| Yes |	numeric, 8 char |
| version	| Header, the PayFast API version.	| Yes |	v1 |
| timestamp	| Header, the current timestamp. |	Yes |	ISO-8601 date and time, YYYY-MM-DDTHH:MM:SS[+HH:MM] |
| signature |	Header, MD5 hash of the alphabetised submitted header and body variables, as well as the passphrase.	| Yes	| MD5 hash, characters must be in lower case |
| date |	Body, date of the time period. Defaults to current week |	Optional |	YYYY-MM-DD |

::: details
 A successful monthly response will return comma-separated values (CSV) of required the transactions.
:::

<pre>Unsuccessful monthly response</pre>
```JSON
{
  "code":500,
  "status":"error",
  "data":{
    "response":false
  }
}
```

## Credit Card Transaction Query
The URL to interact with will take the following forms below.

### Live Endpoint:
:::tip
https://api.payfast.co.za/process/query/[Transaction Token / Payfast Payment ID]
:::

### Sandbox Endpoint:
:::tip
https://api.payfast.co.za/process/query/[Transaction Token / Payfast Payment ID]?testing=true
:::
When testing, an optional parameter “testing=true” needs to be appended. This will route transactions to a sandbox environment where no production data is returned.

The Transaction token, or PayFast payment id, needs to be sent to retrieve the transaction details.


#### [GET] query

Query a credit card transaction.

<span style="background-color: #e6e6ff">https://api.payfast.co.za/process/query/01d2e4c7-28c8-3a86-151f-eab5357da649</span><br/><br/>
<span style="background-color: #e6e6ff">https://api.payfast.co.za/process/query/69</span>

| NAME | 	DESCRIPTION |	REQUIRED |	FORMAT |
| --------- | -------- | --------- | --------- |
| merchant-id | Header, the Merchant ID as given by the PayFast system.	| Yes |	numeric, 8 char |
| version	| Header, the PayFast API version.	| Yes |	v1 |
| timestamp	| Header, the current timestamp. |	Yes |	ISO-8601 date and time, YYYY-MM-DDTHH:MM:SS[+HH:MM] |
| signature |	Header, MD5 hash of the alphabetised submitted header and body variables, as well as the passphrase.	| Yes	| MD5 hash, characters must be in lower case |


<pre>Successful query response</pre>
```JSON
{
  "code":200,
  "status":"success",
  "data":{
    "response":{
      "pf_payment_id":"69",
      "m_payment_id":"232345",
      "status":"COMPLETE",
      "amount":"3600",
      "cc_status":"00",
      "cc_message":"Approved or completed successfully (00)"
    },
    "message":"Success"
  }
}
```
<pre>Unsuccessful query response</pre>
```JSON
{
  "code":500,
  "status":"error",
  "data":{
    "response":false
  }
}
```

## API Validation

### CURL Examples
The example below demonstrates a cURL call containing the following:

- HTTP Method: GET
- URL: https://api.payfast.co.za/transactions/history
- Endpoint: /daily. The call is made to v1 (version 1) of the API. The merchant-id, version, timestamp and signature are all included as request headers. The date and format are included in the request body.

<span style="background-color: #e6e6ff">curl -v -X PUT -H “merchant-id: 10000100” -H “version: v1” -H “timestamp: 2017-01-01T12:00:00” -H “signature: 840654b40a8b312e54650e1613696b44” https://api.payfast.co.za/transactions/history/daily</span><br/><br/>
An example of the request information sent can be seen below:


<span style="background-color: #e6e6ff">> GET https://api.payfast.co.za/transactions/history/daily HTTP/1.1</span><br/><br/>
<span style="background-color: #e6e6ff">> User-Agent: curl/7.37.0</span><br/><br/>
<span style="background-color: #e6e6ff">> Host: api.payfast.co.za </span><br/><br/>
<span style="background-color: #e6e6ff">> Accept: */* </span><br/><br/>
<span style="background-color: #e6e6ff">> merchant-id: 10000100</span><br/><br/>
<span style="background-color: #e6e6ff">> version: v1 </span><br/><br/>
<span style="background-color: #e6e6ff">> timestamp: 2017-01-01T12:00:00</span><br/><br/>
<span style="background-color: #e6e6ff">> version: v1 </span><br/><br/>
<span style="background-color: #e6e6ff">> signature: 840654b40a8b312e54650e1613696b44</span><br/><br/>
<span style="background-color: #e6e6ff">> Content-Length: 0 </span><br/><br/>
<span style="background-color: #e6e6ff">> Content-Type: application/x-www-form-urlencoded</span><br/><br/>
```php
<?php
// URL for curl_init
$url = "https://api.payfast.co.za/transactions/history/daily?date=2017-01-01";

// Set up cURL
$ch = curl_init( $url );
curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
curl_setopt( $ch, CURLOPT_HEADER, false );
curl_setopt( $ch, CURLOPT_SSL_VERIFYPEER, 1 );
curl_setopt( $ch, CURLOPT_TIMEOUT, 60 );
curl_setopt( $ch, CURLOPT_CUSTOMREQUEST, "GET" );
curl_setopt( $ch, CURLOPT_VERBOSE, 1 );
curl_setopt( $ch, CURLOPT_HTTPHEADER, array(
    'version: v1',
    'merchant-id: 10000100',
    'signature: 840654b40a8b312e54650e1613696b44',
    'timestamp: 2017-01-01T12:00:00' 
) );

// Execute and close cURL
$response = curl_exec( $ch );
curl_close( $ch );
```
### Errors and Causes
The following errors can be expected during authentication when connecting to PayFast.
| CODE | 	ERROR MESSAGE | 	REASON |
| --------------- | --------------- | ---------------- |
| 400 | Required variables not present in request<br/><br/>Value for signature is not in the expected format<br/><br/>API version is not valid<br/><br/>Signature not present in headers | The request is missing some or all of the required fields.<br/><br/>Generated when the merchant signature provided is not an MD5 hash, or is malformed.<br/><br/>Issued when the version header refers to a version that does not exist, or is malformed.<br/><br/>The signature has not been provided. |
| 401 | Merchant not found <br/><br/>Request origin not recognised<br/><br/>Request origin could not be verified<br/><br/>Merchant authorisation failed | The given merchant ID was not found.<br/><br/>Generated when the request does not contain a REMOTE_ADDR value.<br/><br/>Occurs when the request is made from a location not specified in the whitelist.<br/><br/>The signature is incorrect. |
| 404 | 	Service / endpoint not found | 	The endpoint does not exist or the requesting merchant does not have permission to access. |
| 429 |	Signature rate limit reached, please try again in a few minutes |	The rate limit was hit. |
| 500 | 	Application Error<br/><br/>Communication Failure | Application Error.<br/><br/>Networking issue with the API.|
